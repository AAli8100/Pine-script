# Pine-script
// Â© TheOddCompany

//@version=4
study("Aior Combo Cluster w/Divergence", shorttitle="|BK.GTD|", overlay=true, max_bars_back = 4999, max_lines_count = 500, max_labels_count = 500,  max_bars_back=4999, max_boxes_count=500)
 




///, group = "Divergence Settings"

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// //////////////////////////////////////////////////////////////////////////////// 
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////Divergence Indicator



// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© 
//@version=4
prd = input(defval = 10, title = "Pivot Period", minval = 1, maxval = 100000000000000000, group = "**Divergence Settings**")
source8 = input(defval = "Close", title = "Source for Pivot Points", options = ["Close", "High/Low"], group = "**Divergence Settings**")
searchdiv = input(defval = "Regular/Hidden", title = "Divergence Type", options = ["Regular", "Hidden", "Regular/Hidden"], group = "**Divergence Settings**")
showindis = input(defval = "Don't Show", title = "Show Indicator Names", options = ["Full", "First Letter", "Don't Show"], group = "**Divergence Settings**")
showlimit = input(1, title="Minimum Number of Divergence", minval = 1, maxval = 11, group = "**Divergence Settings**")
maxpp = input(defval = 10, title = "Maximum Pivot Points to Check", minval = 1, maxval = 1000000000, group = "**Divergence Settings**")
maxbars = input(defval = 1000, title = "Maximum Bars to Check", minval = 30, maxval = 100000000, group = "**Divergence Settings**")
shownum = input(defval = true, title = "Show Divergence Number", group = "**Divergence Settings**")
showlast = input(defval = false, title = "Show Only Last Divergence", group = "**Divergence Settings**")
dontconfirm = input(defval = false, title = "Don't Wait for Confirmation", group = "**Divergence Settings**")
showlines = input(defval = false, title = "Show Divergence Lines", group = "**Divergence Settings**")
showpivot = input(defval = false, title = "Show Pivot Points", group = "**Divergence Settings**")
calcmacd = input(defval = true, title = "MACD", group = "**Divergence Settings**")
calcmacda = input(defval = true, title = "MACD Histogram", group = "**Divergence Settings**")
calcrsi = input(defval = true, title = "RSI", group = "**Divergence Settings**")
calcstoc = input(defval = true, title = "Stochastic", group = "**Divergence Settings**")
calccci = input(defval = true, title = "CCI", group = "**Divergence Settings**")
calcmom = input(defval = true, title = "Momentum", group = "**Divergence Settings**")
calcobv = input(defval = true, title = "OBV", group = "**Divergence Settings**")
calcvwmacd = input(true, title = "VWmacd", group = "**Divergence Settings**")
calccmf = input(true, title = "Chaikin Money Flow", group = "**Divergence Settings**")
calcmfi = input(true, title = "Money Flow Index", group = "**Divergence Settings**")
calcext = input(false, title = "Check External Indicator", group = "**Divergence Settings**")
externalindi = input(defval = close, title = "External Indicator", group = "**Divergence Settings**")
pos_reg_div_col = input(defval = color.new(#ffffff, 79), title = "Positive Regular Divergence", group = "**Divergence Settings**")
neg_reg_div_col = input(defval = color.new(#ffffff, 79), title = "Negative Regular Divergence", group = "**Divergence Settings**")
pos_hid_div_col = input(defval = color.new(#ffffff, 79), title = "Positive Hidden Divergence", group = "**Divergence Settings**")
neg_hid_div_col = input(defval = color.new(#ffffff, 79), title = "Negative Hidden Divergence", group = "**Divergence Settings**")
pos_div_text_col = input(defval = color.black, title = "Positive Divergence Text Color", group = "**Divergence Settings**")
neg_div_text_col = input(defval = color.black, title = "Negative Divergence Text Color", group = "**Divergence Settings**")
reg_div_l_style_ = input(defval = "Dotted", title = "Regular Divergence Line Style", options = ["Solid", "Dashed", "Dotted"], group = "**Divergence Settings**")
hid_div_l_style_ = input(defval = "Dashed", title = "Hdden Divergence Line Style", options = ["Solid", "Dashed", "Dotted"], group = "**Divergence Settings**")
reg_div_l_width = input(defval = 1, title = "Regular Divergence Line Width", minval = 1, maxval = 5, group = "**Divergence Settings**")
hid_div_l_width = input(defval = 1, title = "Hidden Divergence Line Width", minval = 1, maxval = 5, group = "**Divergence Settings**")

cma1col = input(defval = color.lime, title = "", inline = "ma12", group = "**Divergence Settings**")
cma2col = input(defval = color.red, title = "", inline = "ma12", group = "**Divergence Settings**")

// set line styles
var reg_div_l_style = reg_div_l_style_ == "Solid" ? line.style_solid : 
                       reg_div_l_style_ == "Dashed" ? line.style_dashed :
                       line.style_dotted
var hid_div_l_style = hid_div_l_style_ == "Solid" ? line.style_solid : 
                       hid_div_l_style_ == "Dashed" ? line.style_dashed :
                       line.style_dotted


// get indicators
rsi = rsi(close, 8) // RSI
[macd, signal, deltamacd] = macd(close, 12, 26, 9) // MACD
moment = mom(close, 10) // Momentum
cci = cci(close, 10) // CCI
Obv = obv // OBV
stk = sma(stoch(close, high, low, 14), 3) // Stoch
maFast = vwma(close, 12), maSlow = vwma(close, 26), vwmacd = maFast - maSlow // volume weighted macd
Cmfm = ((close-low) - (high-close)) / (high - low), Cmfv = Cmfm * volume, cmf = sma(Cmfv, 21) / sma(volume,21) // Chaikin money flow
Mfi = mfi(close, 14) // Moneyt Flow Index

// keep indicators names and colors in arrays
var indicators_name = array.new_string(11)
var div_colors = array.new_color(4)
if barstate.isfirst
    // names
    array.set(indicators_name, 0, showindis == "Full" ? "MACD" : "M")
    array.set(indicators_name, 1, showindis == "Full" ? "Hist" : "H")
    array.set(indicators_name, 2, showindis == "Full" ? "RSI" : "E")
    array.set(indicators_name, 3, showindis == "Full" ? "Stoch" : "S")
    array.set(indicators_name, 4, showindis == "Full" ? "CCI" : "C")
    array.set(indicators_name, 5, showindis == "Full" ? "MOM" : "M")
    array.set(indicators_name, 6, showindis == "Full" ? "OBV" : "O")
    array.set(indicators_name, 7, showindis == "Full" ? "VWMACD" : "V")
    array.set(indicators_name, 8, showindis == "Full" ? "CMF" : "C")
    array.set(indicators_name, 9, showindis == "Full" ? "MFI" : "M")
    array.set(indicators_name,10, showindis == "Full" ? "Extrn" : "X")
    //colors
    array.set(div_colors, 0, pos_reg_div_col)
    array.set(div_colors, 1, neg_reg_div_col)
    array.set(div_colors, 2, pos_hid_div_col)
    array.set(div_colors, 3, neg_hid_div_col)

// Check if we get new Pivot High Or Pivot Low
float ph = pivothigh((source8 == "Close" ? close : high), prd, prd)
float pl = pivotlow((source8 == "Close" ? close : low), prd, prd)
plotshape(ph and showpivot, text = "H",  style = shape.labeldown, color = color.new(color.white, 100), textcolor = color.red, location = location.abovebar, offset = -prd)
plotshape(pl and showpivot, text = "L",  style = shape.labelup, color = color.new(color.white, 100), textcolor = color.lime, location = location.belowbar, offset = -prd)

// keep values and positions of Pivot Highs/Lows in the arrays
var int maxarraysize = 20
var ph_positions = array.new_int(maxarraysize, 0)
var pl_positions = array.new_int(maxarraysize, 0)
var ph_vals = array.new_float(maxarraysize, 0.)
var pl_vals = array.new_float(maxarraysize, 0.)

// add PHs to the array
if ph
    array.unshift(ph_positions, bar_index)
    array.unshift(ph_vals, ph)
    if array.size(ph_positions) > maxarraysize
        array.pop(ph_positions)
        array.pop(ph_vals)

// add PLs to the array
if pl
    array.unshift(pl_positions, bar_index)
    array.unshift(pl_vals, pl)
    if array.size(pl_positions) > maxarraysize
        array.pop(pl_positions)
        array.pop(pl_vals)

// functions to check Regular Divergences and Hidden Divergences

// function to check positive regular or negative hidden divergence
// cond == 1 => positive_regular, cond == 2=> negative_hidden
positive_regular_positive_hidden_divergence(src, cond)=>
    divlen = 0
    prsc = source8 == "Close" ? close : low
    // if indicators higher than last value and close price is higher than las close 
    if dontconfirm or src > src[1] or close > close[1]
        startpoint = dontconfirm ? 0 : 1 // don't check last candle
        // we search last 15 PPs
        for x = 0 to maxpp - 1
            len = bar_index - array.get(pl_positions, x) + prd
            // if we reach non valued array element or arrived 101. or previous bars then we don't search more
            if array.get(pl_positions, x) == 0 or len > maxbars
                break
            if len > 5 and 
               ((cond == 1 and src[startpoint] > src[len] and prsc[startpoint] < nz(array.get(pl_vals, x))) or
               (cond == 2 and src[startpoint] < src[len] and prsc[startpoint] > nz(array.get(pl_vals, x))))
                slope1 = (src[startpoint] - src[len]) / (len - startpoint)
                virtual_line1 = src[startpoint] - slope1
                slope2 = (close[startpoint] - close[len]) / (len - startpoint)
                virtual_line2 = close[startpoint] - slope2
                arrived = true
                for y = 1 + startpoint to len - 1
                    if src[y] < virtual_line1 or nz(close[y]) < virtual_line2
                        arrived := false
                        break
                    virtual_line1 := virtual_line1 - slope1
                    virtual_line2 := virtual_line2 - slope2
                
                if arrived
                    divlen := len
                    break
    divlen

// function to check negative regular or positive hidden divergence
// cond == 1 => negative_regular, cond == 2=> positive_hidden
negative_regular_negative_hidden_divergence(src, cond)=>
    divlen = 0
    prsc = source8 == "Close" ? close : high
    // if indicators higher than last value and close price is higher than las close 
    if dontconfirm or src < src[1] or close < close[1]
        startpoint = dontconfirm ? 0 : 1 // don't check last candle
        // we search last 15 PPs
        for x = 0 to maxpp - 1
            len = bar_index - array.get(ph_positions, x) + prd
            // if we reach non valued array element or arrived 101. or previous bars then we don't search more
            if array.get(ph_positions, x) == 0 or len > maxbars
                break
            if len > 5 and 
               ((cond == 1 and src[startpoint] < src[len] and prsc[startpoint] > nz(array.get(ph_vals, x))) or 
               (cond == 2 and src[startpoint] > src[len] and prsc[startpoint] < nz(array.get(ph_vals, x))))
                slope1 = (src[startpoint] - src[len]) / (len - startpoint)
                virtual_line1 = src[startpoint] - slope1
                slope2 = (close[startpoint] - nz(close[len])) / (len - startpoint)
                virtual_line2 = close[startpoint] - slope2
                arrived = true
                for y = 1 + startpoint to len - 1
                    if src[y] > virtual_line1 or nz(close[y]) > virtual_line2
                        arrived := false
                        break
                    virtual_line1 := virtual_line1 - slope1
                    virtual_line2 := virtual_line2 - slope2
                
                if arrived
                    divlen := len
                    break
    divlen

// calculate 4 types of divergence if enabled in the options and return divergences in an array
calculate_divs(cond, indicator)=>
    divs = array.new_int(4, 0)
    array.set(divs, 0, cond and (searchdiv == "Regular" or searchdiv == "Regular/Hidden") ? positive_regular_positive_hidden_divergence(indicator, 1) : 0)
    array.set(divs, 1, cond and (searchdiv == "Regular" or searchdiv == "Regular/Hidden") ? negative_regular_negative_hidden_divergence(indicator, 1) : 0)
    array.set(divs, 2, cond and (searchdiv == "Hidden" or searchdiv == "Regular/Hidden")  ? positive_regular_positive_hidden_divergence(indicator, 2) : 0)
    array.set(divs, 3, cond and (searchdiv == "Hidden" or searchdiv == "Regular/Hidden")  ? negative_regular_negative_hidden_divergence(indicator, 2) : 0)
    divs

// array to keep all divergences
var all_divergences = array.new_int(44) // 11 indicators * 4 divergence = 44 elements
// set related array elements
array_set_divs(div_pointer, index)=>
    for x = 0 to 3
        array.set(all_divergences, index * 4 + x, array.get(div_pointer, x))

// set divergences array 
array_set_divs(calculate_divs(calcmacd, macd), 0)
array_set_divs(calculate_divs(calcmacda, deltamacd), 1)
array_set_divs(calculate_divs(calcrsi, rsi), 2)
array_set_divs(calculate_divs(calcstoc, stk), 3)
array_set_divs(calculate_divs(calccci, cci), 4)
array_set_divs(calculate_divs(calcmom, moment), 5)
array_set_divs(calculate_divs(calcobv, Obv), 6)
array_set_divs(calculate_divs(calcvwmacd, vwmacd), 7)
array_set_divs(calculate_divs(calccmf, cmf), 8)
array_set_divs(calculate_divs(calcmfi, Mfi), 9)
array_set_divs(calculate_divs(calcext, externalindi), 10)

// check minimum number of divergence, if less than showlimit then delete all divergence
total_div = 0
for x = 0 to array.size(all_divergences) - 1
    total_div := total_div + round(sign(array.get(all_divergences, x)))

if total_div < showlimit
    array.fill(all_divergences, 0)

// keep line in an array
var pos_div_lines = array.new_line(0)
var neg_div_lines = array.new_line(0)
var pos_div_labels = array.new_label(0)
var neg_div_labels = array.new_label(0) 

// remove old lines and labels if showlast option is enabled
delete_old_pos_div_lines()=>
    if array.size(pos_div_lines) > 0    
        for j = 0 to array.size(pos_div_lines) - 1 
            line.delete(array.get(pos_div_lines, j))
        array.clear(pos_div_lines)

delete_old_neg_div_lines()=>
    if array.size(neg_div_lines) > 0    
        for j = 0 to array.size(neg_div_lines) - 1 
            line.delete(array.get(neg_div_lines, j))
        array.clear(neg_div_lines)

delete_old_pos_div_labels()=>
    if array.size(pos_div_labels) > 0 
        for j = 0 to array.size(pos_div_labels) - 1 
            label.delete(array.get(pos_div_labels, j))
        array.clear(pos_div_labels)

delete_old_neg_div_labels()=>
    if array.size(neg_div_labels) > 0    
        for j = 0 to array.size(neg_div_labels) - 1 
            label.delete(array.get(neg_div_labels, j))
        array.clear(neg_div_labels)

// delete last creted lines and labels until we met new PH/PV 
delete_last_pos_div_lines_label(n)=>
    if n > 0 and array.size(pos_div_lines) >= n    
        asz = array.size(pos_div_lines)
        for j = 1 to n
            line.delete(array.get(pos_div_lines, asz - j))
            array.pop(pos_div_lines)
        if array.size(pos_div_labels) > 0  
            label.delete(array.get(pos_div_labels, array.size(pos_div_labels) - 1))
            array.pop(pos_div_labels)

delete_last_neg_div_lines_label(n)=>
    if n > 0 and array.size(neg_div_lines) >= n    
        asz = array.size(neg_div_lines)
        for j = 1 to n
            line.delete(array.get(neg_div_lines, asz - j))
            array.pop(neg_div_lines)
        if array.size(neg_div_labels) > 0  
            label.delete(array.get(neg_div_labels, array.size(neg_div_labels) - 1))
            array.pop(neg_div_labels)
            
// variables for Alerts
pos_reg_div_detected = false
neg_reg_div_detected = false
pos_hid_div_detected = false
neg_hid_div_detected = false

// to remove lines/labels until we met new // PH/PL
var last_pos_div_lines = 0
var last_neg_div_lines = 0
var remove_last_pos_divs = false 
var remove_last_neg_divs = false
if pl
    remove_last_pos_divs := false
    last_pos_div_lines := 0
if ph
    remove_last_neg_divs := false
    last_neg_div_lines := 0

// draw divergences lines and labels
divergence_text_top = ""
divergence_text_bottom = ""
distances = array.new_int(0)
dnumdiv_top = 0
dnumdiv_bottom = 0
top_label_col = color.white
bottom_label_col = color.white
old_pos_divs_can_be_removed = true
old_neg_divs_can_be_removed = true
startpoint = dontconfirm ? 0 : 1 // used for don't confirm option

for x = 0 to 10
    div_type = -1
    for y = 0 to 3
        if array.get(all_divergences, x * 4 + y) > 0 // any divergence?
            div_type := y
            if (y % 2) == 1 
                dnumdiv_top := dnumdiv_top + 1
                top_label_col := array.get(div_colors, y)
            if (y % 2) == 0
                dnumdiv_bottom := dnumdiv_bottom + 1
                bottom_label_col := array.get(div_colors, y)
            if not array.includes(distances, array.get(all_divergences, x * 4 + y))  // line not exist ?
                array.push(distances, array.get(all_divergences, x * 4 + y))
                new_line = showlines ? line.new(x1 = bar_index - array.get(all_divergences, x * 4 + y), 
                          y1 = (source8 == "Close" ? close[array.get(all_divergences, x * 4 + y)] : 
                                           (y % 2) == 0 ? low[array.get(all_divergences, x * 4 + y)] : 
                                                          high[array.get(all_divergences, x * 4 + y)]),
                          x2 = bar_index - startpoint,
                          y2 = (source8 == "Close" ? close[startpoint] : 
                                           (y % 2) == 0 ? low[startpoint] : 
                                                          high[startpoint]),
                          color = array.get(div_colors, y),
                          style = y < 2 ? reg_div_l_style : hid_div_l_style,
                          width = y < 2 ? reg_div_l_width : hid_div_l_width
                          )
                          : na
                if (y % 2) == 0
                    if old_pos_divs_can_be_removed
                        old_pos_divs_can_be_removed := false
                        if not showlast and remove_last_pos_divs
                            delete_last_pos_div_lines_label(last_pos_div_lines)
                            last_pos_div_lines := 0
                        if showlast
                            delete_old_pos_div_lines()
                    array.push(pos_div_lines, new_line)
                    last_pos_div_lines := last_pos_div_lines + 1
                    remove_last_pos_divs := true
                    
                if (y % 2) == 1
                    if old_neg_divs_can_be_removed
                        old_neg_divs_can_be_removed := false
                        if not showlast and remove_last_neg_divs
                            delete_last_neg_div_lines_label(last_neg_div_lines)
                            last_neg_div_lines := 0
                        if showlast
                            delete_old_neg_div_lines()
                    array.push(neg_div_lines, new_line)
                    last_neg_div_lines := last_neg_div_lines + 1
                    remove_last_neg_divs := true
                    
            // set variables for alerts
            if y == 0
                pos_reg_div_detected := true
            if y == 1
                neg_reg_div_detected := true
            if y == 2
                pos_hid_div_detected := true
            if y == 3
                neg_hid_div_detected := true
    // get text for labels
    if div_type >= 0
        divergence_text_top    := divergence_text_top    + ((div_type % 2) == 1 ? (showindis != "Don't Show" ? array.get(indicators_name, x) + "\n" : "") : "")
        divergence_text_bottom := divergence_text_bottom + ((div_type % 2) == 0 ? (showindis != "Don't Show" ? array.get(indicators_name, x) + "\n" : "") : "")


// draw labels
if showindis != "Don't Show" or shownum
    if shownum and dnumdiv_top > 0
        divergence_text_top := divergence_text_top + tostring(dnumdiv_top)
    if shownum and dnumdiv_bottom > 0
        divergence_text_bottom := divergence_text_bottom + tostring(dnumdiv_bottom)
    if divergence_text_top != ""
        if showlast
            delete_old_neg_div_labels()
        array.push(neg_div_labels, 
                      label.new( x = bar_index, 
                                 y = max(high, high[1]), 
                                 text = divergence_text_top,
                                 color = top_label_col,
                                 textcolor = neg_div_text_col,
                                 style = label.style_label_down,  size = size.small
                                 ))
                                 
    if divergence_text_bottom != ""
        if showlast
            delete_old_pos_div_labels()
        array.push(pos_div_labels, 
                      label.new( x = bar_index, 
                                 y = min(low, low[1]), 
                                 text = divergence_text_bottom,
                                 color = bottom_label_col, 
                                 textcolor = pos_div_text_col,
                                 style = label.style_label_up,  size = size.small
                                 ))
                                 
    
//alertcondition(pos_reg_div_detected, title='Positive Regular Divergence Detected', message='Positive Regular Divergence Detected')
//alertcondition(neg_reg_div_detected, title='Negative Regular Divergence Detected', message='Negative Regular Divergence Detected')
//alertcondition(pos_hid_div_detected, title='Positive Hidden Divergence Detected', message='Positive Hidden Divergence Detected')
//alertcondition(neg_hid_div_detected, title='Negative Hidden Divergence Detected', message='Negative Hidden Divergence Detected')

alertcondition(pos_reg_div_detected or pos_hid_div_detected, title='Buy Signal Divergence Detected', message='Buy Signal Divergence Detected on {{ticker}}, At {{close}}, On The {{interval}} Timeframe')
alertcondition(neg_reg_div_detected or neg_hid_div_detected, title='Sell Signal Divergence Detected', message='Sell Signal Divergence Detected on {{ticker}}, At {{close}}, On The {{interval}} Timeframe')

//alertcondition(isRsiOB2 or isRsiOS2, title="BUY OR Sell Signal Detected for Entry #1", message="BUY OR Sell Signal Detected for Entry #1 on {{ticker}}, At {{close}}, On The {{interval}} Timeframe")





/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////Divergence INDICATOR #2///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////Divergence INDICATOR #2///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////Divergence INDICATOR #2///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



prd2 = input(defval = 400, title = "Pivot Period", minval = 1, maxval = 100000000000000000, group = "**Divergence Settings #2**", inline= "D2")
source82 = input(defval = "Close", title = "Source for Pivot Points", options = ["Close", "High/Low"], group = "**Divergence Settings #2**", inline= "D2")
searchdiv2 = input(defval = "Regular/Hidden", title = "Divergence Type", options = ["Regular", "Hidden", "Regular/Hidden"], group = "**Divergence Settings #2**", inline= "D2")
showindis2 = input(defval = "Don't Show", title = "Show Indicator Names", options = ["Full", "First Letter", "Don't Show"], group = "**Divergence Settings #2**", inline= "D2")
showlimit2 = input(1, title="Mini Number of Divergence", minval = 1, maxval = 11, group = "**Divergence Settings #2**", inline= "D2")
maxpp2 = input(defval = 10, title = "Max Pivot Points", minval = 1, maxval = 1000000000, group = "**Divergence Settings #2**", inline= "D2")
maxbars2 = input(defval = 1000, title = "Maximum Bars", minval = 30, maxval = 100000000, group = "**Divergence Settings #2**", inline= "D2")
shownum2 = input(defval = true, title = "Show Divergence Number", group = "**Divergence Settings #2**", inline= "")
showlast2 = input(defval = false, title = "Show Only Last Divergence", group = "**Divergence Settings #2**", inline= "")
dontconfirm2 = input(defval = false, title = "Don't Wait for Confirmation", group = "**Divergence Settings #2**", inline= "")
showlines2 = input(defval = false, title = "Show Divergence Lines", group = "**Divergence Settings #2**", inline= "")
showpivot2 = input(defval = false, title = "Show Pivot Points", group = "**Divergence Settings #2**", inline= "")
calcmacd2 = input(defval = true, title = "MACD", group = "**Divergence Settings #2**",inline= "")
calcmacda2 = input(defval = true, title = "MACD Histogram", group = "**Divergence Settings #2**", inline= "")
calcrsi2 = input(defval = true, title = "RSI", group = "**Divergence Settings #2**", inline= "")
calcstoc2 = input(defval = true, title = "Stochastic", group = "**Divergence Settings #2**", inline= "")
calccci2 = input(defval = true, title = "CCI", group = "**Divergence Settings #2**", inline= "")
calcmom2 = input(defval = true, title = "Momentum", group = "**Divergence Settings #2**", inline= "")
calcobv2 = input(defval = true, title = "OBV", group = "**Divergence Settings #2**", inline= "")
calcvwmacd2 = input(true, title = "VWmacd", group = "**Divergence Settings #2**", inline= "")
calccmf2 = input(true, title = "Chaikin Money Flow", group = "**Divergence Settings #2**", inline= "")
calcmfi2 = input(true, title = "Money Flow Index", group = "**Divergence Settings #2**", inline= "")
calcext2 = input(false, title = "Check External Indicator", group = "**Divergence Settings #2**", inline= "")
externalindi2 = input(defval = close, title = "External Indicator", group = "**Divergence Settings #2**", inline= "")
pos_reg_div_col2 = input(defval = color.new(#2962ff, 79), title = "Positive Regular Divergence", group = "**Divergence Color Settings #2**", inline= "DC2")
neg_reg_div_col2 = input(defval = color.new(#2962ff, 79), title = "Negative Regular Divergence", group = "**Divergence Color Settings #2**", inline= "DC2")
pos_hid_div_col2 = input(defval = color.new(#2962ff, 79), title = "Positive Hidden Divergence", group = "**Divergence Color Settings #2**", inline= "DC2")
neg_hid_div_col2 = input(defval = color.new(#2962ff, 79), title = "Negative Hidden Divergence", group = "**Divergence Color Settings #2**", inline= "DC2")
pos_div_text_col2 = input(defval = color.black, title = "Positive Divergence Text Color", group = "**Divergence Color Settings #2**", inline= "DC2")
neg_div_text_col2 = input(defval = color.black, title = "Negative Divergence Text Color", group = "**Divergence Color Settings #2**", inline= "DC2")
reg_div_l_style_2 = input(defval = "Dotted", title = "Regular Divergence Line Style", options = ["Solid", "Dashed", "Dotted"], group = "**Divergence Settings #2**", inline= "D2")
hid_div_l_style_2 = input(defval = "Dashed", title = "Hdden Divergence Line Style", options = ["Solid", "Dashed", "Dotted"], group = "**Divergence Settings #2**", inline= "D2")
reg_div_l_width2 = input(defval = 1, title = "Regular Divergence Line Width", minval = 1, maxval = 5, group = "**Divergence Settings #2**", inline= "D2")
hid_div_l_width2 = input(defval = 1, title = "Hidden Divergence Line Width", minval = 1, maxval = 5, group = "**Divergence Settings #2**", inline= "D2")

cma1col2 = input(defval = color.lime, title = "", inline = "ma12", group = "**Divergence Settings #2**", inline= "D2")
cma2col2 = input(defval = color.red, title = "", inline = "ma12", group = "**Divergence Settings #2**", inline= "D2")

// set line styles
var reg_div_l_style2 = reg_div_l_style_2 == "Solid" ? line.style_solid : 
                       reg_div_l_style_2 == "Dashed" ? line.style_dashed :
                       line.style_dotted
var hid_div_l_style2 = hid_div_l_style_2 == "Solid" ? line.style_solid : 
                       hid_div_l_style_2 == "Dashed" ? line.style_dashed :
                       line.style_dotted


// get indicators
rsi2 = rsi(close, 8) // RSI
[macd2, signal2, deltamacd2] = macd(close, 12, 26, 9) // MACD
moment2 = mom(close, 10) // Momentum
cci2 = cci(close, 10) // CCI
Obv2 = obv // OBV
stk2 = sma(stoch(close, high, low, 14), 3) // Stoch
maFast2 = vwma(close, 12), maSlow2 = vwma(close, 26), vwmacd2 = maFast2 - maSlow2 // volume weighted macd
Cmfm2 = ((close-low) - (high-close)) / (high - low), Cmfv2 = Cmfm2 * volume, cmf2 = sma(Cmfv2, 21) / sma(volume,21) // Chaikin money flow
Mfi2 = mfi(close, 14) // Moneyt Flow Index

// keep indicators names and colors in arrays
var indicators_name2 = array.new_string(11)
var div_colors2 = array.new_color(4)
if barstate.isfirst
    // names
    array.set(indicators_name2, 0, showindis2 == "Full" ? "MACD" : "M")
    array.set(indicators_name2, 1, showindis2 == "Full" ? "Hist" : "H")
    array.set(indicators_name2, 2, showindis2 == "Full" ? "RSI" : "E")
    array.set(indicators_name2, 3, showindis2 == "Full" ? "Stoch" : "S")
    array.set(indicators_name2, 4, showindis2 == "Full" ? "CCI" : "C")
    array.set(indicators_name2, 5, showindis2 == "Full" ? "MOM" : "M")
    array.set(indicators_name2, 6, showindis2 == "Full" ? "OBV" : "O")
    array.set(indicators_name2, 7, showindis2 == "Full" ? "VWMACD" : "V")
    array.set(indicators_name2, 8, showindis2 == "Full" ? "CMF" : "C")
    array.set(indicators_name2, 9, showindis2 == "Full" ? "MFI" : "M")
    array.set(indicators_name2,10, showindis2 == "Full" ? "Extrn" : "X")
    //colors
    array.set(div_colors2, 0, pos_reg_div_col2)
    array.set(div_colors2, 1, neg_reg_div_col2)
    array.set(div_colors2, 2, pos_hid_div_col2)
    array.set(div_colors2, 3, neg_hid_div_col2)

// Check if we get new Pivot High Or Pivot Low
float ph2 = pivothigh((source82 == "Close" ? close : high), prd2, prd2)
float pl2 = pivotlow((source82 == "Close" ? close : low), prd2, prd2)
plotshape(ph2 and showpivot2, text = "H",  style = shape.labeldown, color = color.new(color.white, 100), textcolor = color.red, location = location.abovebar, offset = -prd2)
plotshape(pl2 and showpivot2, text = "L",  style = shape.labelup, color = color.new(color.white, 100), textcolor = color.lime, location = location.belowbar, offset = -prd2)

// keep values and positions of Pivot Highs/Lows in the arrays
var int maxarraysize2 = 20
var ph_positions2 = array.new_int(maxarraysize2, 0)
var pl_positions2 = array.new_int(maxarraysize2, 0)
var ph_vals2 = array.new_float(maxarraysize2, 0.)
var pl_vals2 = array.new_float(maxarraysize2, 0.)

// add PHs to the array
if ph2
    array.unshift(ph_positions2, bar_index)
    array.unshift(ph_vals2, ph2)
    if array.size(ph_positions2) > maxarraysize2
        array.pop(ph_positions2)
        array.pop(ph_vals2)

// add PLs to the array
if pl2
    array.unshift(pl_positions2, bar_index)
    array.unshift(pl_vals2, pl2)
    if array.size(pl_positions2) > maxarraysize2
        array.pop(pl_positions2)
        array.pop(pl_vals2)

// functions to check Regular Divergences and Hidden Divergences

// function to check positive regular or negative hidden divergence
// cond == 1 => positive_regular, cond == 2=> negative_hidden
positive_regular_positive_hidden_divergence2(src2, cond2)=>
    divlen2 = 0
    prsc2 = source82 == "Close" ? close : low
    // if indicators higher than last value and close price is higher than las close 
    if dontconfirm2 or src2 > src2[1] or close > close[1]
        startpoint2 = dontconfirm2 ? 0 : 1 // don't check last candle
        // we search last 15 PPs
        for x2 = 0 to maxpp2 - 1
            len2 = bar_index - array.get(pl_positions2, x2) + prd2
            // if we reach non valued array element or arrived 101. or previous bars then we don't search more
            if array.get(pl_positions2, x2) == 0 or len2 > maxbars2
                break
            if len2 > 5 and
               ((cond2 == 1 and src2[startpoint2] > src2[len2] and prsc2[startpoint2] < nz(array.get(pl_vals2, x2))) or
               (cond2 == 2 and src2[startpoint2] < src2[len2] and prsc2[startpoint2] > nz(array.get(pl_vals2, x2))))
                slope12 = (src2[startpoint2] - src2[len2]) / (len2 - startpoint2)
                virtual_line12 = src2[startpoint2] - slope12
                slope22 = (close[startpoint2] - close[len2]) / (len2 - startpoint2)
                virtual_line22 = close[startpoint2] - slope22
                arrived2 = true
                for y2 = 1 + startpoint2 to len2 - 1
                    if src2[y2] < virtual_line12 or nz(close[y2]) < virtual_line22
                        arrived2 := false
                        break
                    virtual_line12 := virtual_line12 - slope12
                    virtual_line22 := virtual_line22 - slope22
                
                if arrived2
                    divlen2 := len2
                    break
    divlen2

// function to check negative regular or positive hidden divergence
// cond == 1 => negative_regular, cond == 2=> positive_hidden
negative_regular_negative_hidden_divergence2(src2, cond2)=>
    divlen2 = 0
    prsc2 = source82 == "Close" ? close : high
    // if indicators higher than last value and close price is higher than las close 
    if dontconfirm2 or src2 < src2[1] or close < close[1]
        startpoint2 = dontconfirm2 ? 0 : 1 // don't check last candle
        // we search last 15 PPs
        for x2 = 0 to maxpp2 - 1
            len2 = bar_index - array.get(ph_positions2, x2) + prd2
            // if we reach non valued array element or arrived 101. or previous bars then we don't search more
            if array.get(ph_positions2, x2) == 0 or len2 > maxbars2
                break
            if len2 > 5 and 
               ((cond2 == 1 and src2[startpoint2] < src2[len2] and prsc2[startpoint2] > nz(array.get(ph_vals2, x2))) or 
               (cond2 == 2 and src2[startpoint2] > src2[len2] and prsc2[startpoint2] < nz(array.get(ph_vals2, x2))))
                slope12 = (src2[startpoint2] - src2[len2]) / (len2 - startpoint2)
                virtual_line12 = src2[startpoint2] - slope12
                slope22 = (close[startpoint2] - nz(close[len2])) / (len2 - startpoint2)
                virtual_line22 = close[startpoint2] - slope22
                arrived2 = true
                for y2 = 1 + startpoint2 to len2 - 1
                    if src2[y2] > virtual_line12 or nz(close[y2]) > virtual_line22
                        arrived2 := false
                        break
                    virtual_line12 := virtual_line12 - slope12
                    virtual_line22 := virtual_line22 - slope22
                
                if arrived2
                    divlen2 := len2
                    break
    divlen2

// calculate 4 types of divergence if enabled in the options and return divergences in an array
calculate_divs2(cond2, indicator2)=>
    divs2 = array.new_int(4, 0)
    array.set(divs2, 0, cond2 and (searchdiv2 == "Regular" or searchdiv2 == "Regular/Hidden") ? positive_regular_positive_hidden_divergence2(indicator2, 1) : 0)
    array.set(divs2, 1, cond2 and (searchdiv2 == "Regular" or searchdiv2 == "Regular/Hidden") ? negative_regular_negative_hidden_divergence2(indicator2, 1) : 0)
    array.set(divs2, 2, cond2 and (searchdiv2 == "Hidden" or searchdiv2 == "Regular/Hidden")  ? positive_regular_positive_hidden_divergence2(indicator2, 2) : 0)
    array.set(divs2, 3, cond2 and (searchdiv2 == "Hidden" or searchdiv2 == "Regular/Hidden")  ? negative_regular_negative_hidden_divergence2(indicator2, 2) : 0)
    divs2

// array to keep all divergences
var all_divergences2 = array.new_int(44) // 11 indicators * 4 divergence = 44 elements
// set related array elements
array_set_divs2(div_pointer2, index2)=>
    for x2 = 0 to 3
        array.set(all_divergences2, index2 * 4 + x2, array.get(div_pointer2, x2))

// set divergences array 
array_set_divs2(calculate_divs2(calcmacd2, macd2), 0)
array_set_divs2(calculate_divs2(calcmacda2, deltamacd2), 1)
array_set_divs2(calculate_divs2(calcrsi2, rsi2), 2)
array_set_divs2(calculate_divs2(calcstoc2, stk2), 3)
array_set_divs2(calculate_divs2(calccci2, cci2), 4)
array_set_divs2(calculate_divs2(calcmom2, moment2), 5)
array_set_divs2(calculate_divs2(calcobv2, Obv2), 6)
array_set_divs2(calculate_divs2(calcvwmacd2, vwmacd2), 7)
array_set_divs2(calculate_divs2(calccmf2, cmf2), 8)
array_set_divs2(calculate_divs2(calcmfi2, Mfi2), 9)
array_set_divs2(calculate_divs2(calcext2, externalindi2), 10)

// check minimum number of divergence, if less than showlimit then delete all divergence
total_div2 = 0
for x2 = 0 to array.size(all_divergences2) - 1
    total_div2 := total_div2 + round(sign(array.get(all_divergences2, x2)))

if total_div2 < showlimit2
    array.fill(all_divergences2, 0)

// keep line in an array
var pos_div_lines2 = array.new_line(0)
var neg_div_lines2 = array.new_line(0)
var pos_div_labels2 = array.new_label(0)
var neg_div_labels2 = array.new_label(0) 

// remove old lines and labels if showlast option is enabled
delete_old_pos_div_lines2()=>
    if array.size(pos_div_lines2) > 0    
        for j2 = 0 to array.size(pos_div_lines2) - 1 
            line.delete(array.get(pos_div_lines2, j2))
        array.clear(pos_div_lines2)

delete_old_neg_div_lines2()=>
    if array.size(neg_div_lines2) > 0    
        for j2 = 0 to array.size(neg_div_lines2) - 1 
            line.delete(array.get(neg_div_lines2, j2))
        array.clear(neg_div_lines2)

delete_old_pos_div_labels2()=>
    if array.size(pos_div_labels2) > 0 
        for j2 = 0 to array.size(pos_div_labels2) - 1 
            label.delete(array.get(pos_div_labels2, j2))
        array.clear(pos_div_labels2)

delete_old_neg_div_labels2()=>
    if array.size(neg_div_labels2) > 0    
        for j2 = 0 to array.size(neg_div_labels2) - 1 
            label.delete(array.get(neg_div_labels2, j2))
        array.clear(neg_div_labels2)

// delete last creted lines and labels until we met new PH/PV 
delete_last_pos_div_lines_label2(n2)=>
    if n2 > 0 and array.size(pos_div_lines2) >= n2    
        asz2 = array.size(pos_div_lines2)
        for j2 = 1 to n2
            line.delete(array.get(pos_div_lines2, asz2 - j2))
            array.pop(pos_div_lines2)
        if array.size(pos_div_labels2) > 0  
            label.delete(array.get(pos_div_labels2, array.size(pos_div_labels2) - 1))
            array.pop(pos_div_labels2)

delete_last_neg_div_lines_label2(n2)=>
    if n2 > 0 and array.size(neg_div_lines2) >= n2    
        asz2 = array.size(neg_div_lines2)
        for j2 = 1 to n2
            line.delete(array.get(neg_div_lines2, asz2 - j2))
            array.pop(neg_div_lines2)
        if array.size(neg_div_labels2) > 0  
            label.delete(array.get(neg_div_labels2, array.size(neg_div_labels2) - 1))
            array.pop(neg_div_labels2)
            
// variables for Alerts
pos_reg_div_detected2 = false
neg_reg_div_detected2 = false
pos_hid_div_detected2 = false
neg_hid_div_detected2 = false

// to remove lines/labels until we met new // PH/PL
var last_pos_div_lines2 = 0
var last_neg_div_lines2 = 0
var remove_last_pos_divs2 = false 
var remove_last_neg_divs2 = false
if pl2
    remove_last_pos_divs2 := false
    last_pos_div_lines2 := 0
if ph2
    remove_last_neg_divs2 := false
    last_neg_div_lines2 := 0

// draw divergences lines and labels
divergence_text_top2 = ""
divergence_text_bottom2 = ""
distances2 = array.new_int(0)
dnumdiv_top2 = 0
dnumdiv_bottom2 = 0
top_label_col2 = color.white
bottom_label_col2 = color.white
old_pos_divs_can_be_removed2 = true
old_neg_divs_can_be_removed2 = true
startpoint2 = dontconfirm2 ? 0 : 1 // used for don't confirm option

for x2 = 0 to 10
    div_type2 = -1
    for y2 = 0 to 3
        if array.get(all_divergences2, x2 * 4 + y2) > 0 // any divergence?
            div_type2 := y2
            if (y2 % 2) == 1 
                dnumdiv_top2 := dnumdiv_top2 + 1
                top_label_col2 := array.get(div_colors2, y2)
            if (y2 % 2) == 0
                dnumdiv_bottom2 := dnumdiv_bottom2 + 1
                bottom_label_col2 := array.get(div_colors2, y2)
            if not array.includes(distances2, array.get(all_divergences2, x2 * 4 + y2))  // line not exist ?
                array.push(distances2, array.get(all_divergences2, x2 * 4 + y2))
                new_line2 = showlines2 ? line.new(x1 = bar_index - array.get(all_divergences2, x2 * 4 + y2), 
                          y1 = (source82 == "Close" ? close[array.get(all_divergences2, x2 * 4 + y2)] : 
                                           (y2 % 2) == 0 ? low[array.get(all_divergences2, x2 * 4 + y2)] : 
                                                          high[array.get(all_divergences2, x2 * 4 + y2)]),
                          x2 = bar_index - startpoint2,
                          y2 = (source82 == "Close" ? close[startpoint2] : 
                                           (y2 % 2) == 0 ? low[startpoint2] : 
                                                          high[startpoint2]),
                          color = array.get(div_colors2, y2),
                          style = y2 < 2 ? reg_div_l_style2 : hid_div_l_style2,
                          width = y2 < 2 ? reg_div_l_width2 : hid_div_l_width2
                          )
                          : na
                if (y2 % 2) == 0
                    if old_pos_divs_can_be_removed2
                        old_pos_divs_can_be_removed2 := false
                        if not showlast2 and remove_last_pos_divs2
                            delete_last_pos_div_lines_label2(last_pos_div_lines2)
                            last_pos_div_lines2 := 0
                        if showlast2
                            delete_old_pos_div_lines2()
                    array.push(pos_div_lines2, new_line2)
                    last_pos_div_lines2 := last_pos_div_lines2 + 1
                    remove_last_pos_divs2 := true
                    
                if (y2 % 2) == 1
                    if old_neg_divs_can_be_removed2
                        old_neg_divs_can_be_removed2 := false
                        if not showlast2 and remove_last_neg_divs2
                            delete_last_neg_div_lines_label2(last_neg_div_lines2)
                            last_neg_div_lines2 := 0
                        if showlast2
                            delete_old_neg_div_lines2()
                    array.push(neg_div_lines2, new_line2)
                    last_neg_div_lines2 := last_neg_div_lines2 + 1
                    remove_last_neg_divs2 := true
                    
            // set variables for alerts
            if y2 == 0
                pos_reg_div_detected2 := true
            if y2 == 1
                neg_reg_div_detected2 := true
            if y2 == 2
                pos_hid_div_detected2 := true
            if y2 == 3
                neg_hid_div_detected2 := true
    // get text for labels
    if div_type2 >= 0
        divergence_text_top2    := divergence_text_top2    + ((div_type2 % 2) == 1 ? (showindis2 != "Don't Show" ? array.get(indicators_name2, x2) + "\n" : "") : "")
        divergence_text_bottom2 := divergence_text_bottom2 + ((div_type2 % 2) == 0 ? (showindis2 != "Don't Show" ? array.get(indicators_name2, x2) + "\n" : "") : "")


// draw labels
if showindis2 != "Don't Show" or shownum2
    if shownum2 and dnumdiv_top2 > 0
        divergence_text_top2 := divergence_text_top2 + tostring(dnumdiv_top2)
    if shownum2 and dnumdiv_bottom2 > 0
        divergence_text_bottom2 := divergence_text_bottom2 + tostring(dnumdiv_bottom2)
    if divergence_text_top2 != ""
        if showlast2
            delete_old_neg_div_labels2()
        array.push(neg_div_labels2,
                      label.new( x = bar_index, 
                                 y = max(high, high[1]), 
                                 text = divergence_text_top2,
                                 color = top_label_col2,
                                 textcolor = neg_div_text_col2,
                                 style = label.style_label_down,  size = size.small
                                 ))
                                 
    if divergence_text_bottom2 != ""
        if showlast2
            delete_old_pos_div_labels2()
        array.push(pos_div_labels2,
                      label.new( x = bar_index, 
                                 y = min(low, low[1]), 
                                 text = divergence_text_bottom2,
                                 color = bottom_label_col2, 
                                 textcolor = pos_div_text_col2,
                                 style = label.style_label_up,  size = size.small
                                 ))
                                 
    
//alertcondition(pos_reg_div_detected, title='Positive Regular Divergence Detected', message='Positive Regular Divergence Detected')
//alertcondition(neg_reg_div_detected, title='Negative Regular Divergence Detected', message='Negative Regular Divergence Detected')
//alertcondition(pos_hid_div_detected, title='Positive Hidden Divergence Detected', message='Positive Hidden Divergence Detected')
//alertcondition(neg_hid_div_detected, title='Negative Hidden Divergence Detected', message='Negative Hidden Divergence Detected')

alertcondition(pos_reg_div_detected2 or pos_hid_div_detected2, title='Buy Signal Divergence Detected #2', message='Buy Signal Divergence Detected #2 on {{ticker}}, At {{close}}, On The {{interval}} Timeframe')
alertcondition(neg_reg_div_detected2 or neg_hid_div_detected2, title='Sell Signal Divergence Detected #2', message='Sell Signal Divergence Detected #2 #2 on, inline= "" {{ticker}}, At {{close}}, On The {{interval}} Timeframe')

//alertcondition(isRsiOB2 or isRsiOS2, title="BUY OR Sell Signal Detected for Entry #1", message="BUY OR Sell Signal Detected for Entry #1 on {{ticker}}, At {{close}}, On The {{interval}} Timeframe")






